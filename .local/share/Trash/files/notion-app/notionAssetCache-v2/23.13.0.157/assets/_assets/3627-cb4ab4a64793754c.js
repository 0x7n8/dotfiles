"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[3627],{43627:(t,o,e)=>{e.r(o),e.d(o,{addAutomationAction:()=>$,deleteAutomation:()=>N,disableAutomation:()=>O,duplicateAutomation:()=>B,duplicateAutomationAction:()=>W,enableAutomation:()=>D,insertEmptyTextInDuplicateBlockAction:()=>U,messages:()=>P,removeAutomationAction:()=>j,reorderAutomationActions:()=>V});e(21703);var n=e(59786),a=e(2647),i=e(37955),r=e(73110),c=e(76218),s=e(606),d=e(98963),u=e(18844),l=e(23867),m=e(70203),p=e(9291),f=e(53965),g=e(37850),M=e(7032),S=e(40470),y=e(1898),_=e(81575),v=e(54532),A=e(94419),C=e(19785),h=e(9953),R=e(24677),b=e(98104),T=e(13447),w=e(95477),I=e(27105),k=e(97978),x=e(49117),K=e(73959);const P=(0,p.defineMessages)({genericErrorMessage:{id:"automations.buttonTrigger.genericErrorMessage",defaultMessage:"Button failed to execute"},open:{defaultMessage:"Open",id:"automations.buttonTrigger.open"},undo:{defaultMessage:"Undo",id:"automations.buttonTrigger.undo"},defaultConfirmationWorkflowText:{defaultMessage:"Are you sure you want to continue?",id:"automations.buttonTrigger.defaultConfirmationWorkflowText"},defaultContinueWorkflowMessage:{defaultMessage:"Continue",id:"automations.buttonTrigger.defaultContinueWorkflowMessage"},defaultStopWorkflowMessage:{defaultMessage:"Cancel",id:"automations.buttonTrigger.defaultStopWorkflowMessage"},errorQueryCollectionTooManyPages:{defaultMessage:"Button impacts too many pages",id:"automations.buttonTrigger.errorQueryCollectionTooManyPages"},errorUserCancelled:{defaultMessage:"Button was cancelled",id:"automations.buttonTrigger.errorUserCancelled"},errorRecordInTrash:{id:"automations.buttonTrigger.errorRecordInTrash",defaultMessage:"Button is editing a page in trash"}});function $(t){const{actionId:o,environment:e,intl:n,automationStore:i,actionType:r,transaction:c,insertionPoint:s,config:l,createDuplicateBlocksContainer:p=!0}=t,f=i.getSpaceId();if(!f)return;let g;"duplicate_blocks"===r&&p&&(g=h.j4({environment:e,inMemoryRecordCache:i.inMemoryRecordCache,transaction:c,type:"text",useCrdt:I.dy({source:"automation_action"})}));const M=l??function(t){const{actionType:o,intl:e}=t;if("modal_confirmation"===o)return{continue_button:{text:e.formatMessage(P.defaultContinueWorkflowMessage)},cancel_button:{text:e.formatMessage(P.defaultStopWorkflowMessage)},text:{type:"simple",value:(0,m.TPx)(e.formatMessage(P.defaultConfirmationWorkflowText))}};if("assistant"===o)return{type:"prompt"}}({actionType:r,intl:n})??{},S=h.ae({environment:e,inMemoryRecordCache:i.inMemoryRecordCache,table:u.Xj,transaction:c,value:{id:o,type:r,parent_id:i.id,parent_table:d.cv,alive:!0,space_id:f,config:M,blocks:g?[g.id]:[]}});g&&A.R3({transaction:c,parent:S.getKeyStore("blocks"),append:g}),!s||"afterActionId"in s?A.R3({transaction:c,parent:i.getActionIdsStore(),append:S,after:null==s?void 0:s.afterActionId}):"beforeActionId"in s?A.Ce({transaction:c,parent:i.getActionIdsStore(),prepend:S,before:s.beforeActionId}):(0,y.t1)(s);const _=S.getModel();if((0,y.$K)(_)){const t=(0,k.mc)(e),o=(0,a.Bj)({automationActionModel:_,getRecordModel:S.getRecordModel});(0,a.A2)(t,{automation_action:o,automation_action_id:_.id,automation_id:_.parent_id}),(0,a.eI)(t,{automation_action_id:_.id,automation_action_type:_.type,automation_id:i.id})}return S}function B(t){const{actorPointer:o,environment:e,includeParenting:n,sourceAutomationStore:a,targetAutomationId:r,transaction:c}=t,s=a.getParentStore();if(!s||!s.isReady())throw new Error("Automation parent store not ready");const u=a.getValue(),l=a.getSpaceId();if(!(0,y.$K)(u)||!(0,y.$K)(l))throw new Error("Undefined automation value or space id");const m={},p={...(0,f.Xh)(u),id:r??(0,M.ZP)()};m[a.id]=p.id,(0,y.$K)(p.action_ids)&&(0,y.Of)(p.action_ids)&&p.action_ids.forEach((t=>m[t]=(0,M.ZP)()));const S=t=>{let{requested:o}=t;const e=m[o.id];return(0,y.$K)(e)?{...o,id:e}:o};(0,i.J_)({actor:o,duplicateRecord:p,options:{},mapper:S,originalRecord:u});const _=h.ae({environment:e,inMemoryRecordCache:a.inMemoryRecordCache,table:d.cv,transaction:c,value:p});n&&C.jG({childStore:_,parentStore:s,transaction:c});const v=a.getActionStores(),A=g.Lc(v,10,(t=>{const o=m[t.id],{automationActionStore:n,onComplete:a}=W({environment:e,includeParenting:!1,mapper:S,sourceActionStore:t,targetAutomationActionId:o,transaction:c});return C.jG({childStore:n,parentStore:_,transaction:c}),a})),R=A.then((t=>t.flat()));return{automationStore:_,onComplete:R}}function W(t){const{environment:o,includeParenting:e,insertionPoint:n,mapper:r,sourceActionStore:c,targetAutomationActionId:s,transaction:d}=t,m=c.getParentStore();if(!m||!m.isReady())throw new Error("Automation store is not ready");const p=c.getValue(),S=c.getSpaceId();if(!(0,y.$K)(p)||!(0,y.$K)(S))throw new Error("Undefined action value or space id");const _={...(0,f.Xh)(p),id:s??(0,M.ZP)()},A=o.currentUser.id,R=c.inMemoryRecordCache.makeGetRecordRoleFn(A);(0,i.XJ)({duplicateRecord:_,getRecordRole:R,originalRecord:p,mapper:t=>(null==r?void 0:r(t))??t.requested,options:{},originOptions:{baseUrl:w.default.domainBaseUrl,publicDomainName:w.default.publicDomainName}});const b=h.ae({environment:o,inMemoryRecordCache:c.inMemoryRecordCache,table:u.Xj,transaction:d,value:_});e&&(!n||"afterActionId"in n?C.jG({after:null==n?void 0:n.afterActionId,childStore:b,parentStore:m,transaction:d}):"beforeActionId"in n?C.SH({before:null==n?void 0:n.beforeActionId,childStore:b,parentStore:m,transaction:d}):(0,y.t1)(n));const T=g.Lc(c.getBlockStores(),10,(t=>{const[e,n]=v.Qi({addCopyName:!1,baseUrl:w.default.domainBaseUrl,deepCopyTransclusionContainers:!1,environment:o,preferDuplicateLocation:"local",publicDomainName:w.default.publicDomainName,resolveTemplateVariables:!1,stores:[t],targetSpaceId:(0,l.C)(t.pointer.spaceId),transaction:d,useCrdt:I.dy({source:"automation_action"})}),a=e[0];return C.jG({childStore:a,parentStore:b,transaction:d}),n})),x=b.getModel();if((0,y.$K)(x)){const t=(0,k.mc)(o),e=(0,a.Bj)({automationActionModel:x,getRecordModel:b.getRecordModel});(0,a.A2)(t,{automation_action:e,automation_action_id:x.id,automation_id:x.parent_id,from:"duplicate"}),(0,a.eI)(t,{automation_action_id:x.id,automation_action_type:x.type,automation_id:m.id,from:"duplicate"})}return{automationActionStore:b,onComplete:T}}function V(t){const{clientContext:o,transaction:e,newActionIds:n}=t,{automationStore:a}=o,i=a.getValue();if(!i)return;h.sW({store:a,transaction:e,data:{action_ids:n}});E({clientContext:o,transaction:e,automationValue:{...i,action_ids:n}})}function j(t){var o;const{clientContext:e,actionStore:n,environment:a,transaction:i}=t,r=e.automationStore.getValue();if(!r)return;X({automationActionStore:n,environment:a,transaction:i});E({clientContext:e,transaction:i,automationValue:{...r,action_ids:null===(o=r.action_ids)||void 0===o?void 0:o.filter((t=>t!==n.id))}})}function E(t){const{clientContext:o,automationValue:e,transaction:a}=t,i=o.automationStore.getSpaceId();if(!i)return;const s=(0,x.pt)({context:o,automationValue:e});if(!S.x.isFail(s))for(const d of e.action_ids??[]){const t=o.automationStore.getRecordStore(o.automationStore,{table:u.Xj,id:d,spaceId:i});if(!t.isDefined())continue;const e=t.getModel(),l=new Set(s.value.actionInputValueTypes[d].map((t=>{if(t.kind===r.yp.Binding||t.kind===r.yp.ContextValue)return t.id;t.kind!==r.yp.ThisRow&&(0,y.t1)(t)})).filter(y.$K)),m=(0,n.z)(e.getType()).acceptFormulaVisitor({action:e,visitor:{visitVariableOutsideOfFormula:t=>l.has(t)?{type:"keep"}:{type:"replace",value:void 0},visitFormula:t=>t.value&&(0,c.UB)(t).some((t=>!l.has(t)))?{type:"replace",value:void 0}:{type:"keep"}}});for(const o of m)T.applyOperation({store:t,operation:o,transaction:a})}}function U(t){var o;const{environment:e,parentStore:n,transaction:a}=t,i=h.j4({environment:e,type:"text",inMemoryRecordCache:n.inMemoryRecordCache,transaction:a,spaceId:n.pointer.spaceId,useCrdt:(null===(o=(0,K.sQ)(n))||void 0===o?void 0:o.useCrdt())??!1}),r=A.R3({parent:n,append:i,transaction:a}).child;R.eP({environment:e,store:r});const c=r.getBlockTitleStore();b.N_({store:c})}function D(t){const{automationStore:o,environment:e,transaction:n}=t;h.sW({store:o,data:{status:"active"},transaction:n});const i=o.getModel();if((0,y.$K)(i)){const t=(0,k.mc)(e),n=(0,a.TY)({automationModel:i,getRecordModel:o.getRecordModel});(0,a.Rt)(t,n)}}function O(t){const{automationStore:o,environment:e,status:n,transaction:i}=t,r=n??"disabled";h.sW({store:o,data:{status:r},transaction:i}),o.isTriggerType("recurrence")&&h.sW({store:o,data:{run_at:void 0},transaction:i});const c=o.getModel();if((0,y.$K)(c)){const t=(0,k.mc)(e),n=(0,a.TY)({automationModel:c,getRecordModel:o.getRecordModel});(0,a.ai)(t,n)}}function N(t){const{automationStore:o,environment:e,transaction:n}=t;h.sW({store:o,data:{alive:!1},transaction:n});const i=o.getActionStores();for(const a of i)X({automationActionStore:a,automationStore:o,environment:e,transaction:n});const r=o.getModel();if((0,y.$K)(r)){const t=(0,k.mc)(e),n=(0,a.TY)({automationModel:r,getRecordModel:o.getRecordModel});(0,a.uO)(t,n),r.isNotificationType()&&_.xi(e,{type:"granular",source:"collection_view_settings",collection_id:r.parent_id})}}function X(t){const{automationActionStore:o,automationStore:e,environment:n,transaction:i}=t;let r=o.getParentStore();if((0,y.$K)(e)){const t=o.getParentPointer();if(!(0,y.$K)(t))throw new Error("Automation action does not have a parent pointer");if(!s.dr.isEqual(t,e.pointer))throw new Error(`Automation action parent pointer does not match argument: ${s.dr.toKey(t)}, ${s.dr.toKey(e.pointer)}`);r=e}else if(!(0,y.$K)(r))throw new Error("Automation store is undefined");C.hr({childStore:o,parentStore:r,transaction:i});const c=o.getBlockStores();for(const a of c)C.hr({childStore:a,parentStore:o,transaction:i});const d=o.getModel();if((0,y.$K)(d)){const t=(0,k.mc)(n),e=(0,a.Bj)({automationActionModel:d,getRecordModel:o.getRecordModel});(0,a.OK)(t,{automation_action:e,automation_action_id:d.id,automation_id:d.parent_id}),(0,a.co)(t,{automation_action_id:d.id,automation_action_type:d.type,automation_id:r.id})}}}}]);