(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[5482],{5482:(e,t,n)=>{"use strict";n.r(t),n.d(t,{DictationBubble:()=>Lt,StopDictationButton:()=>nn,dictationActions:()=>o});var o={};n.r(o),n.d(o,{AudioSessionBlockWriter:()=>ht,DictationManager:()=>vt,Segment:()=>dt,smartToggleDictation:()=>mt,startDictation:()=>St,stopDictation:()=>wt});n(57658),n(21703);var i=n(41432),r=n(70203),s=n(90038),a=n(94419),c=n(9953),l=n(993),d=n(13447);function u(e){return{all:e=e||new Map,on:function(t,n){var o=e.get(t);o?o.push(n):e.set(t,[n])},off:function(t,n){var o=e.get(t);o&&(n?o.splice(o.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var o=e.get(t);o&&o.slice().map((function(e){e(n)})),(o=e.get("*"))&&o.slice().map((function(e){e(t,n)}))}}}var h=n(12847);const p={English:["English","en"],Chinese:["Chinese","zh"],Spanish:["Spanish","es"],French:["French","fr"],German:["German","de"],Japanese:["Japanese","ja"],Korean:["Korean","ko"],Portuguese:["Portuguese","pt"],Russian:["Russian","ru"],Thai:["Thai","th"],Vietnamese:["Vietnamese","vi"],Danish:["Danish","da"],Finnish:["Finnish","fi"],Norwegian:["Norwegian","no"],Dutch:["Dutch","nl"],Swedish:["Swedish","sv"]},g=h.union([h.number(),h.string(),h.boolean(),h.isNull(),h.array(h.string())]),f=h.undefinable(g),v=(h.union([g,h.record(h.string(),g)]),h.union([f,h.record(h.string(),f)])),m=(h.union([v,h.record(h.string(),v)]),h.without(h.without(h.nonEmpty(h.string()),"{"),"}"),h.union([h.object({required:{id:h.string(),status:h.literal("pending"),audioDuration:h.number()},optional:{}}),h.object({required:{id:h.string(),status:h.literal("complete"),text:h.string(),audioDuration:h.number()},optional:{}}),h.object({required:{id:h.string(),status:h.literal("error"),reason:h.string(),audioDuration:h.number()},optional:{}}),h.object({required:{id:h.string(),status:h.literal("ignore"),audioDuration:h.number()},optional:{}})])),S=h.union([h.object({required:{type:h.literal("transcription"),audioSessionId:h.string(),segmentId:h.string(),transcription:m,isSegmentComplete:h.boolean(),isAudioSessionComplete:h.boolean()},optional:{}}),h.object({required:{type:h.literal("response"),status:h.literals("ok","error"),requestId:h.string(),result:h.any()},optional:{}})]);h.object({required:{base64Audio:h.string()},optional:{language:h.literals(...Object.values(p).map((e=>{let[t,n]=e;return n})))}}),h.object({required:{},optional:{}}),h.object({required:{},optional:{language:h.literals(...Object.values(p).map((e=>{let[t,n]=e;return n})))}}),h.object({required:{},optional:{}}),h.object({required:{},optional:{}}),h.object({required:{},optional:{}});var w=n(68626),y=n(53965),b=n(52629),k=n(76870),C=n(37850),x=n(7032),R=n(1525),I=n(19584),P=n(63811),D=n(95477),B=n(22705);n(88632);const M=!1;var A=n(1302),T=n(97978),j=n(77080);function _(e,t){A.default.afterNextFlush((()=>{j.default.checkGate("audio_processor_client_send_request_metric_enabled")&&T.j(e,"audio_processor.client.send_request",t)}))}const E=u(),q="transcription",L=async()=>n.e(7168).then(n.bind(n,69053)),Z=!1,N=90*I.C0;function F(e){return{_id:e,charactersSent:0,requestsSent:0,requestsTimedOut:0,responsesReceivedWithoutHandlers:0,successfulResponsesReceived:0,unsuccessfulResponsesReceived:0,invalidMessagesReceived:0,notificationsReceived:0,messagesReceived:0}}const O=new s.z(100),z=new Map,K=(Date.now(),"audioProcessorInternals"),$=new w.BatchedLogger({from:K,type:"BulkDebug",level:"info",maxLength:250,logToConsole:Z});let V,U=0,W=0,G=0,H=0,J=F(0),Q=null,X=null,Y=null,ee=0,te=R.O,ne=!1,oe="uninitialized";const ie=!0;function re(e){$.log({level:"info",from:K,type:e})}function se(){V=function(e){var t;const n=null==e||null===(t=e.socket)||void 0===t||null===(t=t.transport)||void 0===t||null===(t=t.query)||void 0===t?void 0:t.transport;if("websocket"===n||"polling"===n)return n}(this),re(`ping:${V}`),Q=Date.now(),be(`Incoming primus ping received from server via ${V}.`)}function ae(){return{...O.getStats()}}function ce(e){switch($.log({level:"info",from:K,type:"readyStateChange",data:{message:e}}),Y=Date.now(),e){case"end":oe="closed";break;case"open":oe="open";break;case"opening":oe="opening"}}const le=y.HP((e=>async function(e){if(M)return;if(we(e))return void w.log({level:"warning",from:K,type:"CreatePrimusClientCalledForNativeAudioProcessorClient"});U+=1;const{createClient:t}=await L(),n=t({minReconnectDelayMs:.5*I.C0,maxReconnectDelayMs:1*I.C0});return n.on("data",me),n.on("open",(()=>{re("open"),de(e)})),n.on("reconnected",(e=>{ge(),$.log({level:"info",from:K,type:"reconnected",data:{message:`Reconnected in ${null==e?void 0:e.duration} ms`}})})),n.on("reconnect",(()=>{re("reconnect")})),n.on("reconnect scheduled",(e=>{$.log({level:"info",from:K,type:"reconnect scheduled",data:{message:`Reconnecting in ${null==e?void 0:e.scheduled} ms, attempt ${null==e?void 0:e.attempt} of ${null==e?void 0:e.retries}`}})})),n.on("reconnect timeout",(()=>{re("reconnect timeout")})),n.on("reconnect failed",(()=>{re("reconnect failed")})),n.on("timeout",(()=>{re("timeout")})),n.on("destroy",(()=>{re("destroy")})),n.on("close",(()=>{re("close")})),n.on("online",(()=>{re("online")})),n.on("offline",(()=>{re("offline")})),n.on("error",(e=>{let t;t="TransportError"===e.type?{level:"info",from:K,type:"primusTransportError",error:(0,b.Ui)(e)}:{level:"error",from:K,type:"unknownPrimusError",error:(0,b.Ui)(e)};(0,k.lB)(1)&&w.rateLimitedLog(t),$.log(t),G+=1})),n.on("incoming::ping",se),n.on("readyStateChange",ce),n.on("end",(()=>{re("end"),n.off("readyStateChange",ce),W+=1,async function(e,t){var n,o;w.log({level:"info",from:K,type:"audioProcessorEnd",error:{message:`SocketId: ${null==e||null===(n=e.socket)||void 0===n?void 0:n.id} Query:${null==e||null===(o=e.transport)||void 0===o?void 0:o.query}`}}),pe(),te.setTimeout((()=>{void 0!==e&&e.destroy()}),0);const i=await le(t);if(e!==i)return;le.cache.clear(),te.setTimeout((()=>{le(t)}),2*I.C0)}(n,e)})),window.__primusClient_audioProcessor=n,n}(e)),(function(){return"primus_audioProcessor"}));function de(e){J=F(J._id+1),Z&&function(){const e=Date.now(),t=20;function n(){const o=ae();if(0===o.queue&&0===o.running)return be(`Queues emptied after ${Date.now()-e} ms`),void(ue=void 0);ue=window.setTimeout(n,t)}ue&&window.clearTimeout(ue);be("Starting measurement of time until send queues are empty."),n()}()}let ue,he;function pe(){var e;ne=!1,function(){for(const e of z.values())window.clearTimeout(e.timeout);z.clear()}(),O.cancel(),null===(e=he)||void 0===e||e()}function ge(){B.ZP.state.enabled||pe()}async function fe(e){var t;const{base64Audio:n,environment:o,language:i}=e;return await(null===(t=ve({method:"audioData",request:{base64Audio:n,language:i},environment:o}))||void 0===t?void 0:t.response)}function ve(e){if(M)return;const{method:t,request:n,environment:o}=e;_(o,{status:"enqueued",endpoint:t});const i=O.enqueue((()=>{var i;const r=(0,x.ZP)();!function(e,t){A.default.afterNextFlush((()=>{j.default.checkGate("audio_processor_client_send_request_metric_enabled")&&(T.j(e,"audio_processor.client.send_request.queue_running_size",{value:t.running}),T.j(e,"audio_processor.client.send_request.queue_backup_size",{value:t.queue}))}))}(o,O.getStats());const s=C.UZ(),a=Date.now(),c=ie?window.setTimeout((()=>{"open"===oe&&(J.requestsTimedOut+=1,$.log({level:"info",from:K,type:"requestTimeout",data:{requestId:r,time:Date.now()-a}}))}),N):void 0;z.set(r,{resolve:s.resolve,reject:s.reject,timeout:c,sendTime:a}),$.log({level:"info",from:K,type:"requestSent",data:{requestId:r,method:t}});const l={type:`${D.default.audioProcessor.api}/${t}`,requestId:r,...n};return J.requestsSent+=1,async function(e){const{message:t,environment:n}=e,o=Se(n),i=JSON.stringify(t);J.charactersSent+=i.length,ee<i.length&&(ee=i.length);if(o)o(i);else{const e=await le(n);null==e||e.write(t)}}({message:l,environment:o}),null===(i=e.onRequestSent)||void 0===i||i.call(e),s.promise.then((e=>{_(o,{status:"success",endpoint:t})})).catch((e=>{const n=O.getStats();_(o,{status:"failure",endpoint:t,queue_running_size:n.running,queue_backup_size:n.queue})})),s.promise}));return{response:i.catch((e=>{e instanceof ye&&!we(o)&&!ne?(ne=!0,H+=1,re("connectionResetDueToFailedRequest"),le(o).then((e=>{null==e||e.end()})),be(`sendRequest() for ${t} returned server error (${e.message}), resetting connection`,n)):be(`sendRequest() cancelled or errored for ${t} (${e.message})`,n)})),asyncQueuePromise:i}}function me(e){J.messagesReceived+=1;const t=(0,P.Gu)(S,e);if(t)return J.invalidMessagesReceived+=1,void w.rateLimitedLog({level:"warning",from:K,type:"ValidationError",data:{miscDataToConvertToString:e},error:(0,b.Ui)(t)});const n=e;switch(n.type){case"response":{var o;const{requestId:e,status:t,result:i}=n,r=z.get(e);if(z.delete(e),$.log({level:"info",from:K,type:"responseReceived",data:{requestId:e,response:t,time:r&&Date.now()-r.sendTime,internalProcessingTimeMs:null===(o=n.result)||void 0===o?void 0:o.internalProcessingTimeMs}}),!r)return void(J.responsesReceivedWithoutHandlers+=1);X=Date.now(),window.clearTimeout(r.timeout),"ok"===t?(J.successfulResponsesReceived+=1,r.resolve(i)):(J.unsuccessfulResponsesReceived+=1,r.reject(new ye(i)));break}case"transcription":E.emit(q,n)}}function Se(e){}function we(e){return Boolean(void 0)}class ye extends Error{constructor(e){super(e),this.name="FailedAudioProcessorRequestError"}}function be(){if(Z){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];console.info("audioProcessorInternals:",...t)}}var ke=n(28020),Ce=n(98165),xe=n(83212),Re=n(26842),Ie=n(27724),Pe=n(17277);n(48675),n(63408),n(14590),n(3462),n(23767),n(8585),n(68696);class De{constructor(e,t){this._inputSampleRate=void 0,this._outputSampleRate=void 0,this._inputSampleRate=e,this._outputSampleRate=t}downsample(e){const t=this.downSampleAudioFrame(e,this._inputSampleRate,this._outputSampleRate),n=new ArrayBuffer(4*t.length),o=new DataView(n);for(let i=0,r=0;i<t.length;i++,r+=4){const e=Math.max(-1,Math.min(1,t[i]));o.setFloat32(r,e,!0)}return n}downSampleAudioFrame(e,t,n){if(n===t||n>t)return e;const o=t/n,i=Math.round(e.length/o),r=new Float32Array(i);let s=0,a=0;for(;a<i;){const t=Math.round((a+1)*o);let n=0,i=0;for(;s<t&&s<e.length;)n+=e[s++],i++;r[a++]=n/i}return r}}function Be(){const e=navigator.mediaDevices;if(e instanceof MediaDevices)return e;throw new Error("Media devices unavailable in current context.")}function Me(e){const t=window.AudioContext||window.webkitAudioContext||!1;var n;if(Boolean(t))return new t({...(null===(n=navigator)||void 0===n||null===(n=n.mediaDevices)||void 0===n?void 0:n.getSupportedConstraints().sampleRate)&&{sampleRate:e}});throw new Error("Browser does not support Web Audio API (AudioContext is not available).")}var Ae=n(49085);class Te extends Ae.default{constructor(){super()}getInitialState(){}}const je=new Te,_e="initial",Ee="allowed",qe="denied",Le="no_devices",Ze="insecure_context",Ne="unknown_error";class Fe extends Ae.default{async checkPermissions(){const e=await Fe.checkAudioPermissionsThrottled();return this.setState(e),e}getInitialState(){return window.isSecureContext?_e:Ze}}Fe.checkAudioPermissionsThrottled=(0,y.P2)((async()=>{if(!window.isSecureContext)return Ze;try{const e=Be();return function(e){for(const t of e.getTracks())t.stop()}(await e.getUserMedia({video:!1,audio:!0})),Ee}catch(e){if(e instanceof Error)switch(e.name){case"NotAllowedError":return qe;case"NotFoundError":return Le}return Ne}}),1e3);const Oe=new Fe;var ze=n(14577);class Ke extends Ae.default{constructor(){super()}getInitialState(){}}const $e=new Ke;class Ve extends Ae.default{async updateMediaDevices(){try{const e=await async function(){const e=Be();return(await e.enumerateDevices()).reduce(((e,t)=>{if(t.kind&&t.label&&t.deviceId&&t.groupId)switch(t.kind){case"videoinput":e.videoInput.push(t);break;case"audioinput":e.audioInput.push(t);break;case"audiooutput":e.audioOutput.push(t)}return e}),{videoInput:[],audioInput:[],audioOutput:[]})}();this.setState(e)}catch{}}constructor(){super(),this.updateMediaDevices();try{Be().addEventListener("devicechange",(()=>{this.updateMediaDevices()}))}catch{}Oe.addListener((()=>{this.updateMediaDevices()}))}getInitialState(){return{videoInput:[],audioInput:[],audioOutput:[]}}}const Ue=new Ve,We=new ze.Z((()=>{var e,t;return(null===(e=Ue.state)||void 0===e||null===(e=e.audioInput)||void 0===e||null===(t=e.filter)||void 0===t?void 0:t.call(e,(e=>null==e?void 0:e.label)))??[]}),{debugName:"AudioInputDevicesStore"}),Ge=new ze.Z((()=>{var e;const t=je.state,n=null===(e=$e.state)||void 0===e?void 0:e.label,o=We.state.find((e=>e.label===n));return t||(o||We.state[0])}),{debugName:"SelectedAudioInputDeviceStore"}),He=Ue,Je="ms_change";class Qe{constructor(e){this._mediaStream=void 0,this._emitter=void 0,this.recorder=void 0,this.onDataReceived=void 0,this.onStop=void 0,this.startController=void 0,this.handleDeviceChange=async()=>{var e;const t=null===(e=this.mediaStream)||void 0===e||null===(e=e.getAudioTracks()[0])||void 0===e?void 0:e.getSettings(),n=this.getPreferredOrDefaultDevice();if(!t||t.deviceId!==(null==n?void 0:n.deviceId)||t.groupId!==(null==n?void 0:n.groupId)){this.stop(!1);try{await this.start()}catch{this.destroy()}}},this._emitter=u(),this.recorder=new Xe,this.onDataReceived=e.onDataReceived,this.onStop=e.onStop}get emitter(){return this._emitter}set mediaStream(e){var t;if(this._mediaStream)for(const o of this._mediaStream.getTracks())o.stop();if(e)for(const o of e.getTracks())o.addEventListener("ended",(async()=>{if(e.getTracks().every((e=>"ended"===e.readyState))){"denied"===await Oe.checkPermissions()&&this.stop()}}));const n=null==e||null===(t=e.getAudioTracks()[0])||void 0===t?void 0:t.getSettings();je.setState(We.state.find((e=>e.deviceId===(null==n?void 0:n.deviceId)))),this._mediaStream=e,this._emitter.emit(Je)}get mediaStream(){return this._mediaStream}getPreferredOrDefaultDevice(){var e;return(null===(e=We.state)||void 0===e?void 0:e.find((e=>{var t;return e.deviceId===(null===(t=$e.state)||void 0===t?void 0:t.deviceId)})))??We.state[0]}async start(){if(void 0===this.startController||this.startController.signal.aborted){this.startController=new AbortController;const e=this.startController.signal,t=this.getPreferredOrDefaultDevice(),n=Be();if(this.mediaStream=await n.getUserMedia({audio:{deviceId:t?{exact:t.deviceId}:void 0,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,channelCount:1}}),e.aborted)return void(this.mediaStream=void 0);if(await this.recorder.record(this.mediaStream,(t=>{e.aborted||this.onDataReceived(t)}),16e3),e.aborted)return void this.recorder.releaseMediaResources();$e.addListener(this.handleDeviceChange),We.addListener(this.handleDeviceChange)}}stop(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];void 0===this.startController||this.startController.signal.aborted||(this.startController.abort(),this.recorder.releaseMediaResources(),this.mediaStream=void 0,e&&this.onStop&&this.onStop(),$e.removeListener(this.handleDeviceChange),We.removeListener(this.handleDeviceChange))}destroy(){$e.removeListener(this.handleDeviceChange),We.removeListener(this.handleDeviceChange),this.stop()}}class Xe{constructor(){this._audioWorkletNode=void 0,this._sourceNode=void 0,this._audioContext=void 0}set sourceNode(e){this._sourceNode&&this._sourceNode.disconnect(),this._sourceNode=e}set audioWorkletNode(e){this._audioWorkletNode&&this._audioWorkletNode.disconnect(),this._audioWorkletNode=e}set audioContext(e){this._audioContext&&this._audioContext.close(),this._audioContext=e}get audioContext(){return this._audioContext}async record(e,t,o){if(this.releaseMediaResources(),this.audioContext=Me(o),Boolean(this.audioContext.audioWorklet))try{const i=new De(this.audioContext.sampleRate,o),r=this.audioContext.createMediaStreamSource(e);await this.audioContext.audioWorklet.addModule(new URL(n(40366),n.b));const s=new AudioWorkletNode(this.audioContext,"pcm-processor");s.port.onmessage=e=>{if(e.data){const n=e.data,o=i.downsample(n);t(o)}},r.connect(s),this._audioWorkletNode=s,this._sourceNode=r}catch{console.info("unable to create worklet"),this.releaseMediaResources()}else this.releaseMediaResources()}releaseMediaResources(){this.sourceNode=void 0,this.audioWorkletNode=void 0,this.audioContext=void 0}}var Ye=n(68688),et=(n(46314),n(15157)),tt=n(72933),nt=n(80444);function ot(e){return p[e][1]}function it(e){switch(e){case"en-US":default:return"English";case"de-DE":return"German";case"ko-KR":return"Korean";case"zh-CN":case"zh-TW":return"Chinese";case"ja-JP":return"Japanese";case"es-ES":case"es-LA":return"Spanish";case"pt-BR":return"Portuguese";case"fr-FR":return"French";case"da-DK":return"Danish";case"fi-FI":return"Finnish";case"nb-NO":return"Norwegian";case"nl-NL":return"Dutch";case"sv-SE":return"Swedish"}}class rt extends Ae.default{constructor(){super(),this.lastLocalStorageRetrieval=void 0}syncLocalStorageIfNecessary(e){if(!this.lastLocalStorageRetrieval||e!==this.lastLocalStorageRetrieval[0]||Date.now()-this.lastLocalStorageRetrieval[1]>30*I.C0){this.lastLocalStorageRetrieval=[e,Date.now()];const n=et.Z.get({userId:e,key:at});if(Object.hasOwn(p,n))this.state!==n&&this.setState(n);else{var t;const n=it((null===(t=nt.default.state.currentUserSettingsStore)||void 0===t||null===(t=t.getSettings())||void 0===t?void 0:t.preferred_locale)??tt.al);n!==this.state&&this.setState(n),et.Z.set({userId:e,key:at,value:this.state})}}}getInitialState(){var e;return it((null===(e=nt.default.state.currentUserSettingsStore)||void 0===e||null===(e=e.getSettings())||void 0===e?void 0:e.preferred_locale)??tt.al)}}const st=new rt,at="DictationLanguage";function ct(e){return st.syncLocalStorageIfNecessary(e),st.state}const lt=/([\?\!\.])\s/;class dt{constructor(e,t){this.id=void 0,this.text=void 0,this.isCompleteReceived=void 0,this.transcriptions=void 0,this.id=e,this.isCompleteReceived=!!t,this.transcriptions=new Map}updateText(){let e;for(const t of this.transcriptions.values()){if("pending"===t.status)break;"complete"===t.status&&(e=t.text)}this.text=e}setTranscription(e,t){this.transcriptions.set(e,t),this.updateText()}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}getText(){return this.text}isSettled(){return this.isCompleteReceived&&[...this.transcriptions.values()].every((e=>"pending"!==e.status))}}class ut{constructor(e){this.blockStore=void 0,this.segments=void 0,this.isSettled=void 0;const{blockStore:t}=e;this.blockStore=t,this.segments=new Map,this.isSettled=!1}setSegment(e,t){this.segments.set(e,t)}getSegments(){return this.segments.values()}getBlockStore(){return this.blockStore}deleteSegment(e){this.segments.delete(e)}getIsSettled(){return this.isSettled}setIsSettled(e){this.isSettled=e}}class ht{constructor(e){this.id=void 0,this.env=void 0,this.isCompleteReceived=void 0,this.segments=void 0,this.blockSegmentManager=void 0,this.blockSegmentManagers=void 0,this.latestSettledText=void 0;const{id:t,env:n,blockStore:o}=e,i=new ut({blockStore:o});this.id=t,this.env=n,this.isCompleteReceived=!1,this.segments=new Map,this.blockSegmentManagers=new Set([i]),this.blockSegmentManager=i,this.latestSettledText=""}getEnvironment(){return this.env}getOrCreateSegment(e){const t=this.segments.get(e);if(t)return t;{const t=new dt(e);return this.segments.set(e,t),this.blockSegmentManager.setSegment(e,t),t}}getBlockSegmentManager(){return this.blockSegmentManager}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}getFullText(e){return[...e.values()].map((e=>e.getText())).filter((e=>!!e)).join(" ").trim()}isSettled(){return this.isCompleteReceived&&[...this.segments.values()].every((e=>e.isSettled()))}setLatestSettledText(e){this.latestSettledText=e.trim()}getIndexOfBlockSegmentManagers(e){return Array.from(this.blockSegmentManagers).indexOf(e)}addToBlockSegmentManagers(e,t){if("number"==typeof t&&t>=0&&t<this.blockSegmentManagers.size){const n=Array.from(this.blockSegmentManagers);n.splice(t,0,e),this.blockSegmentManagers=new Set(n)}else this.blockSegmentManagers.add(e)}writeToBlock(){const e=this.blockSegmentManager.getBlockStore(),t=this.blockSegmentManager.getBlockStore().getParentBlockStore();if(e&&e.isDictatableBlock()&&t){const n=new Map;for(const e of[...this.blockSegmentManager.getSegments()]){if(!e.isSettled())break;n.set(e.getId(),e)}const o=this.getFullText([...n.values()]),i=function(e){const t=e.split(lt);for(var n=1;n<t.length;n++)"."!==t[n]&&"?"!==t[n]&&"!"!==t[n]||(t[n-1]+=t[n],t[n]="");const o=t.filter((function(e){return void 0!==e&&""!==e})),i=[];let r="";for(const s of o)r.length>=250&&(i.push(r.trim()),r=""),r+=` ${s}`;r.length>0&&(i.push(r.trim()),r="");return i}(this.latestSettledText?[this.latestSettledText,o].join(" "):o);if(i.length>1){const o=i.pop();for(const n of i){const{performResult:o}=pt({environment:this.env,parentBlockStore:t,sibling:e,actionType:"before"}),i=new ut({blockStore:o});i.setIsSettled(!0);const r=this.getIndexOfBlockSegmentManagers(this.blockSegmentManager);this.addToBlockSegmentManagers(i,r),gt({environment:this.env,block:o,transcriptions:[{text:n,settled:!0}]})}[...n.values()].slice(-1).pop()&&o&&this.setLatestSettledText(o??"");for(const e of[...n.keys()])this.blockSegmentManager.deleteSegment(e)}const r=[];this.latestSettledText&&r.push({text:this.latestSettledText,settled:!0});for(const e of this.blockSegmentManager.getSegments()){const t=e.getText();t&&r.push({text:t,settled:e.isSettled()})}gt({environment:this.env,block:this.blockSegmentManager.getBlockStore(),transcriptions:r})}}}function pt(e){let{environment:t,parentBlockStore:n,sibling:o,actionType:r}=e;return d.createAndCommit({userAction:"transcription.test.create",environment:t,perform:e=>{const s=c.j4({environment:t,type:(null==o?void 0:o.getDictationRoleModel())??i.Ti.text,inMemoryRecordCache:n.inMemoryRecordCache,transaction:e,useCrdt:n.useCrdt()});return"before"===r?a.Vt({parent:n.getContentStore(),insert:Re.G.createChildStore(n.getContentStore(),s.pointer),before:o,transaction:e}):a.BE({parent:n.getContentStore(),insert:Re.G.createChildStore(n.getContentStore(),s.pointer),after:o,transaction:e}),s}})}function gt(e){let{environment:t,block:n,transcriptions:o}=e;if(n.isDictatableBlock()){const e=[],i=o.filter((e=>!!e.text));for(const[t,n]of i.entries()){const o=t===i.length-1?n.text:`${n.text} `,s=n.settled?(0,r.V3y)(o):(0,r.V3y)(o,[["dut",Date.now(),Pe.L]]);e.push(s)}d.createAndCommit({userAction:"transcription.test.create",environment:t,perform:o=>{if(!n)throw new Error("No block store provided.");l.sO({environment:t,editorMode:"default",store:n.getBlockTitleStore(),value:e,transaction:o})}})}}function ft(e,t,n){var o;if(n&&!n.pathIsDead()&&n.id!==t.id&&(null===(o=(0,Ce.Dg)(n))||void 0===o?void 0:o.id)===t.id){const t=n.getParentBlockStore();if(n.isEmptyDictatableBlock()&&[...B.ZP.state.audioSessionBlockWriters.values()].every((e=>e.getBlockSegmentManager().getBlockStore().id!==n.id)))return n;if(t)return pt({environment:e,parentBlockStore:t,sibling:n,actionType:"after"}).performResult}return pt({environment:e,parentBlockStore:t}).performResult}class vt{static getCurrentAudioBufferLengthInMS(){return this.audioBuffer.reduce(((e,t)=>e+t.byteLength/4),0)/16}static async getCurrentAudioBufferAsBase64(){const e=this.audioBuffer.splice(0,this.audioBuffer.length);return this.audioEncoderQueue.enqueue((()=>{return t=e,new Promise(((e,n)=>{try{const o=new Blob(t),i=new FileReader;i.readAsDataURL(o),i.onloadend=()=>{var t;const o=null===(t=i.result)||void 0===t?void 0:t.toString().split(",")[1];o?e(o):n(new Error("No base64Audio"))}}catch(o){n(o)}}));var t}))}static getDictationAudioRecorder(e){const{environment:t}=e,n=B.ZP.state.audioRecorder;return n?(n.stop(),n):new Qe({onDataReceived:e=>{var n;this.audioBuffer.push(e);("websocket"===(null===(n=window.__primusClient_audioProcessor)||void 0===n||null===(n=n.socket)||void 0===n||null===(n=n.transport)||void 0===n?void 0:n.name)||this.getCurrentAudioBufferLengthInMS()>500)&&this.getCurrentAudioBufferAsBase64().then((e=>{const n=ot(ct(t.currentUser.id));fe({base64Audio:e,environment:t,language:n}).catch((()=>{}))})).catch((()=>{}))},onStop:()=>{const e=ot(ct(t.currentUser.id));this.getCurrentAudioBufferAsBase64().then((n=>{fe({base64Audio:n,environment:t,language:e}).catch((()=>{}))})).catch((()=>{})).finally((()=>{(async function(e){var t;const{environment:n,language:o}=e;return await(null===(t=ve({method:"audioFinished",request:{language:o},environment:n}))||void 0===t?void 0:t.response)})({environment:t,language:e}).catch((()=>{}))})),wt()}})}static get dictationIsActive(){return Boolean(this.startController&&!this.startController.signal.aborted)}static async smartToggleDictation(e){var t;const n=(0,ke.np)();return this.dictationIsActive&&(null===(t=B.ZP.state.pageBlock)||void 0===t?void 0:t.id)===(null==n?void 0:n.id)?this.stopDictation():this.startDictation(e)}static async startDictation(e){this.stopDictation();try{this.startController=new AbortController,B.ZP.setState({...B.ZP.state,loading:!0});const n=this.startController.signal,o=e.pageBlock??(0,ke.np)();if(!o||!o.isPageBlock()||!(0,Ye.d)(xe.Z.getMode(e.environment,o)))throw new Error("Page is not dictatable.");const i=this.getDictationAudioRecorder(e);new yt;try{const{environment:t}=e;if(await i.start(),Oe.setState(Ee),n.aborted)throw new Error("start dictation aborted");const r=Ie.default.state.stores.slice(-1).pop();B.ZP.setState({...B.ZP.state,audioRecorder:i,enabled:!0,pageBlock:o,block:ft(t,o,r),environment:t})}catch(t){n.aborted||Oe.checkPermissions(),i.destroy()}}catch{this.stopDictation()}finally{B.ZP.setState({...B.ZP.state,loading:!1})}}static stopDictation(){var e;this.startController&&!this.startController.signal.aborted&&(this.startController.abort(),null===(e=B.ZP.state.audioRecorder)||void 0===e||e.destroy(),B.ZP.setState({...B.ZP.state,audioRecorder:void 0,enabled:!1,loading:!1,pageBlock:void 0,block:void 0}))}}async function mt(e){return vt.smartToggleDictation(e)}async function St(e){return vt.startDictation(e)}function wt(){vt.stopDictation()}vt.startController=void 0,vt.audioBuffer=[],vt.audioEncoderQueue=new s.z(1);class yt{constructor(){if(yt.instance)return yt.instance;yt.instance=this,E.on(q,yt.processTranscriptionResult)}static processTranscriptionResult(e){const{audioSessionId:t,segmentId:n,isSegmentComplete:o,isAudioSessionComplete:i}=e,{enabled:r,pageBlock:s,audioSessionBlockWriters:a,environment:c,block:l}=B.ZP.state;if(!a.has(t)&&c&&r){const e=s?ft(c,s,l):void 0;if(e){const n=new ht({id:t,env:c,blockStore:e});a.set(t,n),B.ZP.setState({...B.ZP.state,block:e})}else wt()}const d=a.get(t);if(d){d.setIsCompleteReceived(i);const t=d.getOrCreateSegment(n);t.setIsCompleteReceived(o),t.setTranscription(e.transcription.id,e.transcription)}for(const h of a.values())h.writeToBlock();for(const h of[...a.values()].filter((e=>e.isSettled()))){var u;a.delete(h.getId()),r&&c&&s&&(null===(u=B.ZP.state.block)||void 0===u?void 0:u.id)===h.getBlockSegmentManager().getBlockStore().id&&B.ZP.setState({...B.ZP.state,block:ft(c,s,B.ZP.state.block)})}}}yt.instance=void 0;var bt=n(65820),kt=n(33993),Ct=n(67294),xt=n(86628),Rt=n(24405),It=n(45238),Pt=n(85893);const Dt=(0,It.IU)("face",{viewBox:"0 0 20 20",svg:(0,Pt.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 15 15",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,Pt.jsx)("path",{d:"M8.77466 2.02246L5.01025 11.4435C5.01025 11.4435 5.99019 11.4838 6.82881 11.6749C7.57951 11.8459 8.62557 12.4865 8.62557 12.4865",stroke:"black",strokeWidth:"0.648179",strokeLinecap:"round"}),(0,Pt.jsx)("path",{d:"M8.9704 4.39196C8.9704 4.39196 9.58528 3.90572 9.97993 3.59501C10.2343 3.39475 10.5894 3.19083 10.5894 3.19083C10.8652 3.0298 11.3652 2.94621 11.6745 2.94632C12.2696 2.94652 12.6513 3.33565 12.7239 3.43557C12.8661 3.6315 12.9389 3.873 12.9571 4.10479C12.9737 4.31554 12.8745 5.04712 12.8745 5.04712C12.8745 5.04712 12.7274 5.74318 12.2904 5.98257C12.1179 6.0771 11.9543 6.15451 11.7264 6.0893C11.4695 6.01583 11.3918 5.8817 11.3652 5.61587C11.329 5.25283 11.702 4.88311 11.8439 4.81355C12.049 4.71297 12.3311 4.64471 12.5635 4.68158",stroke:"black",strokeWidth:"0.648179",strokeLinecap:"round"}),(0,Pt.jsx)("rect",{x:"11.5803",y:"4.85645",width:"1.02211",height:"0.961297",fill:"black"}),(0,Pt.jsx)("path",{d:"M1.72852 5.00713C1.72852 5.00713 2.25959 4.43053 2.60067 4.06181C2.82051 3.82416 3.19459 3.51165 3.19459 3.51165C3.44181 3.30938 3.82839 3.13054 4.18863 3.05383C4.77061 2.92991 5.33916 3.29305 5.42648 3.38036C5.59769 3.55157 5.65546 3.67794 5.70981 3.90401C5.75923 4.10955 5.81071 4.29091 5.79534 4.51669C5.76496 4.9627 5.77322 5.26207 5.37915 5.56699C5.22354 5.6874 5.07417 5.78947 4.83881 5.76079C4.57362 5.72848 4.47584 5.60819 4.40794 5.34981C4.31521 4.99695 4.62567 4.57334 4.75491 4.48239C4.94175 4.35091 5.07245 4.25411 5.3077 4.25411",stroke:"black",strokeWidth:"0.648179",strokeLinecap:"round"}),(0,Pt.jsx)("rect",{x:"4.67651",y:"4.39648",width:"0.889315",height:"1.12208",fill:"black"})]})});class Bt extends Ae.default{constructor(){super()}getInitialState(){}setState(e){this.instanceState&&this.instanceState.close(),super.setState(e)}addListener(e){super.addListener(e),this.instanceState||this.setState(Me(24e3))}removeListener(e){super.removeListener(e),0===this.listenerCount()&&this.setState(void 0)}}const Mt=new Bt;var At=n(51454),Tt=n(1898),jt=n(18574);function _t(e){let t=[];return e.nodeType===Node.TEXT_NODE?t.push(e):e.childNodes.forEach((e=>{t=t.concat(_t(e))})),t}const Et=25;function qt(e){let{scrollerStore:t,children:n}=e;const o=(0,xt.VK)((()=>B.CX.state),[]),i=(0,xt.VK)((()=>t.state.scrollTop),[t]),[r,s]=(0,Ct.useState)(),[a,c]=(0,Ct.useState)(),l=(0,jt.Si)(t),d=(0,jt.nA)(t),u=null==l?void 0:l.scrollerEl(),h=null==u?void 0:u.querySelector(".notion-page-content"),p=null==h?void 0:h.querySelector(`[data-block-id="${o}"]`);(0,Ct.useEffect)((()=>{if(h){let e;const t=new MutationObserver((t=>{(0,Tt.$K)(e)&&cancelAnimationFrame(e),e=requestAnimationFrame((()=>s(Date.now())))}));return t.observe(h,{subtree:!0,characterData:!0,childList:!0}),()=>{t.disconnect(),(0,Tt.$K)(e)&&cancelAnimationFrame(e)}}}),[h]),(0,Ct.useEffect)((()=>{if(u){let e;const t=new ResizeObserver((()=>{(0,Tt.$K)(e)&&cancelAnimationFrame(e),e=requestAnimationFrame((()=>s(Date.now())))}));return t.observe(u),()=>{t.disconnect(),(0,Tt.$K)(e)&&cancelAnimationFrame(e)}}}),[u]),(0,Ct.useLayoutEffect)((()=>{if(p&&u){const e=document.createRange(),t=p.querySelector('[data-content-editable-leaf="true"]')??p,n=_t(t),o=u.getBoundingClientRect();if(n.length>0){const t=n[n.length-1];e.selectNodeContents(t),e.collapse(!1);const r=e.getBoundingClientRect(),s=r.top+i-o.top+(r.height-Et)/2,a=r.right-o.left+5;c({top:s,left:a})}else{const e=t.getBoundingClientRect(),n=window.getComputedStyle(t),r=parseInt(n.lineHeight,10),s=parseInt(n.paddingTop,10),a=isNaN(r)?e.height:r,l=isNaN(s)?0:s,d=e.top+l+i-o.top+(a-Et)/2,u=e.left-o.left;c({top:d,left:u})}}else c(void 0)}),[p,u,r,i]);const g=(0,Tt.$K)(a);return(0,Ct.useEffect)((()=>{if(d&&g)switch(d){case"Page":return B.ZP.setState({...B.ZP.state,blockRenderedInPage:!0}),()=>{B.ZP.setState({...B.ZP.state,blockRenderedInPage:!1})};case"PeekView":return B.ZP.setState({...B.ZP.state,blockRenderedInPeekView:!0}),()=>{B.ZP.setState({...B.ZP.state,blockRenderedInPeekView:!1})}}}),[d,g]),a?(0,Pt.jsx)(kt.E.div,{initial:{top:null==a?void 0:a.top,left:null==a?void 0:a.left},animate:{top:null==a?void 0:a.top,left:null==a?void 0:a.left},transition:{duration:.2},style:{display:"block",position:"absolute",zIndex:At.lB-1},children:n}):null}function Lt(e){let{scrollerStore:t}=e;const n=(0,xt.VK)((()=>B.ZP.state.enabled),[]);return(0,Pt.jsx)(bt.M,{children:n?(0,Pt.jsxs)(qt,{scrollerStore:t,children:[(0,Pt.jsx)(Zt,{size:25}),(0,Pt.jsx)(Nt,{})]}):null})}function Zt(e){let{size:t}=e;const n=(0,Rt.yK)((e=>({faceIcon:{width:20,height:20,pointerEvents:"none",color:e.regularTextColor}})),[]),o=(0,Ct.useMemo)((()=>Dt({...n.faceIcon})),[n.faceIcon]);return(0,Pt.jsx)(kt.E.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:0,opacity:0,transition:{type:"spring",duration:.5,bounce:.25}},style:{top:0,left:0,position:"absolute",height:t,width:t,background:"white",boxShadow:"0px 2px 8px rgba(0, 0, 0, 0.14)",borderRadius:15,zIndex:2,display:"flex",justifyContent:"center",alignItems:"center"},children:o})}function Nt(){const e=(0,xt.VK)((()=>B.ZP.getState().audioRecorder),[]),t=(0,xt.VK)((()=>Mt.state),[]),[n,o]=(0,Ct.useState)(0),i=(0,Rt.yK)((e=>({verticalLineColor:{background:e.regularTextColor}})),[]);return(0,Ct.useEffect)((()=>{if(e&&t){const n=new AbortController,i=n.signal,r=()=>{const{mediaStream:n}=e;if(n){const e=t.createMediaStreamSource(n),r=t.createAnalyser();r.fftSize=256,e.connect(r);const s=new Uint8Array(r.frequencyBinCount),a=()=>{if(i.aborted)return void e.disconnect();r.getByteFrequencyData(s);var t;const n=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.9,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1.5;return e<t?o:e>n?i:o+(e-t)/(n-t)*(i-o)}((t=s).length>0?t.reduce(((e,t)=>e+t),0)/t.length:0);o(n),c=requestAnimationFrame(a)};let c=requestAnimationFrame(a);return()=>{cancelAnimationFrame(c),e.disconnect()}}};let s=r();const a=()=>{"function"==typeof s&&s(),s=r()};return e.emitter.on(Je,a),()=>{e.emitter.off(Je,a),"function"==typeof s&&s(),n.abort()}}}),[e,t]),(0,Pt.jsx)(kt.E.div,{initial:{opacity:0,x:-10,rotate:0},animate:{opacity:1,x:0,rotate:10},exit:{opacity:0,x:-10,rotate:0},style:{position:"absolute",left:3,top:0,height:25,width:1,zIndex:1,scaleY:n,scaleX:n,...i.verticalLineColor},transition:{opacity:{duration:.3},x:{type:"tween"}}})}var Ft=n(480),Ot=n(16880);const zt=(0,It.IU)("stop",{viewBox:"0 0 20 20",svg:(0,Pt.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 19 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,Pt.jsx)("rect",{y:"0.793945",width:"18.8027",height:"18.8027",rx:"9.40137",fill:"#37352F"}),(0,Pt.jsx)("rect",{x:"5.91028",y:"6.7041",width:"6.98255",height:"6.98255",rx:"0.783447",fill:"white"})]})});var Kt=n(63747),$t=n(11066),Vt=n(31945),Ut=n(39500),Wt=n(61766),Gt=n(89728),Ht=n(52275),Jt=n(32163),Qt=n(72495),Xt=n(43250);function Yt(e){const t=(0,Ft.O7)(),{parent:n}=e,o=(0,xt.VK)((()=>Object.keys(p).indexOf(ct(t.currentUser.id))),[t.currentUser.id]),i=[{key:"languages",render:e=>(0,Pt.jsx)(Qt.Z,{...e,topBorder:0!==e.index}),items:Object.entries(p).map((e=>{let[o,[i]]=e;const r={key:o,render:e=>(0,Pt.jsx)(Ht.Z,{...e,title:i}),action:()=>{!function(e,t){st.setState(t),et.Z.set({userId:e,key:at,value:t})}(t.currentUser.id,o),n.close()}};return r}))}];return(0,Pt.jsx)("div",{className:Xt.tXr,style:{display:"flex",flexDirection:"column",width:150},children:(0,Pt.jsx)(Jt.Z,{type:Jt.i.Vertical,initialFocus:o,sections:i})})}function en(e){const{languagePopupStore:t}=e,n=(0,Ft.O7)(),o=(0,xt.VK)((()=>We.state),[]),i=(0,xt.VK)((()=>Ge.state),[]),r=(0,xt.VK)((()=>ct(n.currentUser.id)),[n.currentUser.id]);(0,Ct.useEffect)((()=>{He.updateMediaDevices()}),[]);const s=(0,Rt.yK)((e=>({icon:{color:e.regularIconColor},container:{padding:"8px 14px",display:"flex",flexDirection:"column",alignItems:"flex-start",width:300,gap:8},languageSection:{display:"flex",alignItems:"center",width:"100%",justifyContent:"space-between"},microphoneSection:{display:"flex",flexDirection:"column",gap:4,width:"100%"}})),[]),a=(0,Ct.useMemo)((()=>(0,Ot.R)({width:10,height:10,opacity:.6,...s.icon})),[s.icon]);return(0,Pt.jsxs)("div",{style:s.container,children:[(0,Pt.jsxs)("div",{style:s.microphoneSection,children:[(0,Pt.jsx)("div",{style:{opacity:.5,fontSize:14},children:"Microphone"}),(0,Pt.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:6,width:"100%"},children:o.length>0?(0,Pt.jsx)(Pt.Fragment,{children:o.map((e=>(0,Pt.jsx)(tn,{deviceId:e.deviceId,deviceLabel:e.label,selectedDeviceId:null==i?void 0:i.deviceId,onClick:()=>{return t=e,void $e.setState(t);var t}},e.deviceId)))}):"No Devices Available"})]}),(0,Pt.jsxs)("div",{style:s.languageSection,children:[(0,Pt.jsx)("div",{style:{opacity:.5,fontSize:14},children:"Language"}),(0,Pt.jsx)(Vt.ZP,{buttonPopupStore:t,renderOrigin:e=>(0,Pt.jsxs)(Gt.Z,{style:{fontSize:14,display:"flex",alignItems:"center",gap:10},...e,children:[r," ",a]}),stopClickPropagation:!0,popupType:Vt.Z4.Popup,render:e=>(0,Pt.jsx)(Yt,{parent:e})})]})]})}function tn(e){let{selectedDeviceId:t,deviceId:n,deviceLabel:o,onClick:i}=e;const r=(0,Rt.yK)((e=>({parent:{width:"100%",display:"flex",alignItems:"center",justifyContent:"flex-start",gap:10,cursor:"pointer"},radioOval:{width:14,height:14,accentColor:e.regularIconColor,opacity:.8},radioLabel:{fontSize:14,textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap",width:"100%"}})),[]);return(0,Pt.jsxs)("div",{style:r.parent,children:[(0,Pt.jsx)("input",{type:"radio",name:"microphone",value:o,checked:t===n,onChange:()=>i(),style:r.radioOval}),(0,Pt.jsx)("div",{onClick:()=>i(),style:r.radioLabel,children:o})]})}function nn(){return(0,xt.VK)((()=>B.ZP.getState().enabled&&!B.ZP.getState().loading),[])?(0,Pt.jsx)(on,{}):null}function on(){const e=(0,Ft.O7)(),t=(0,xt.VK)((()=>{const e=B.P7.state;if(e)return!e.isDictatableBlock()||e.pathIsDead()}),[]),n=(0,xt.VK)((()=>!B.w7.state),[]),o=(0,xt.qz)(void 0,Wt.Z),i=(0,xt.qz)(void 0,Wt.Z);(0,Ct.useEffect)((()=>{(0,Tt.$K)(t)&&t&&wt()}),[t]),(0,Ct.useEffect)((()=>{if(n){const e=setTimeout((()=>{wt()}),250);return()=>{clearTimeout(e)}}}),[n]);const r=(0,Ct.useCallback)((()=>{wt()}),[]),s=(0,Ct.useCallback)((e=>{null==e||e.stopPropagation(),e&&(0,Ut.uG)(e)||(i.state.open?i.reset():o.state.open?o.reset():o.setState({...o.state,open:!0}))}),[o,i]),a=(0,Kt.r)({rightEdgeDistance:16,isInPeekRenderer:!1,environment:e,overrides:e=>({height:36,background:e.whiteButtonBackground,position:"initial"})}),c=(0,Rt.yK)((e=>({container:{position:"absolute",left:"50%",transform:"translateX(-50%)",bottom:16},dictationButtonStyle:{display:"grid",cursor:"pointer",gridAutoFlow:"column",placeItems:"center",gap:5,alignItems:"center",paddingLeft:6,paddingRight:6},dictationButtonHoveredStyle:{background:e.whiteButtonHoveredBackground},dictationButtonPressedStyle:{background:e.whiteButtonPressedBackground},icon:{color:e.regularIconColor},settingsContainer:{display:"flex",alignItems:"center",justifyContent:"center",height:25,width:25,borderRadius:25},settingsContainerHoveredStyle:{background:e.whiteButtonPressedBackground}})),[]),l=(0,Ct.useMemo)((()=>zt({width:25,height:25,...c.icon})),[c.icon]),d=(0,Ct.useMemo)((()=>(0,Ot.R)({width:10,height:10,opacity:.6,...c.icon})),[c.icon]);return(0,Pt.jsx)("div",{style:{...c.container,zIndex:At.Wd+1},children:(0,Pt.jsx)(Vt.ZP,{buttonPopupStore:o,renderOrigin:()=>(0,Pt.jsxs)($t.Z,{className:"notion-dictation-button",style:{...a,...c.dictationButtonStyle},hoveredStyle:c.dictationButtonHoveredStyle,pressedStyle:c.dictationButtonPressedStyle,onClick:r,children:[l,(0,Pt.jsx)(rn,{}),(0,Pt.jsx)($t.Z,{className:"notion-dictation-button-up-chevron",style:c.settingsContainer,hoveredStyle:c.settingsContainerHoveredStyle,onClick:s,children:d})]}),stopClickPropagation:!0,popupType:e.device.isMobile?Vt.Z4.SlideUp:Vt.Z4.Popup,popupWrapStyle:{marginBottom:14},render:()=>(0,Pt.jsx)(en,{languagePopupStore:i})})})}function rn(){const e=(0,xt.VK)((()=>B.ZP.state.audioRecorder),[]),t=(0,xt.VK)((()=>Mt.state),[]),n=(0,Ct.useRef)(null);return(0,Ct.useEffect)((()=>{if(e&&t){const o=new AbortController,i=o.signal,r=()=>{const{mediaStream:o}=e;if(o){const e=t.createMediaStreamSource(o),r=t.createBiquadFilter();r.type="lowshelf",r.frequency.setValueAtTime(1500,t.currentTime),r.gain.setValueAtTime(-30,t.currentTime);const s=t.createAnalyser();s.fftSize=256,e.connect(r),r.connect(s),t.resume();const a=new Uint8Array(s.frequencyBinCount),c=()=>{if(i.aborted)return e.disconnect(),void r.disconnect();s.getByteFrequencyData(a);const t=n.current,o=null==t?void 0:t.getContext("2d");if(t&&o){const e=window.devicePixelRatio||1,n=t.getBoundingClientRect();t.width=n.width*e,t.height=n.height*e,o.scale(e,e);const i=4;t.width=70*i,t.height=30*i;const r=t.width,s=t.height,c=1*i;let l;o.clearRect(0,0,r,s);const d=2*i;let u=0;for(let t=0;t<a.length;t++){const e=.1*d*Math.random();if(l=Math.max(a[t],d+e)/1.5,o.fillStyle="rgb(128,128,128)",u+c<=r&&o.fillRect(u,s/2-l/2,c,l),u+=c+i,u>=r)break}}l=requestAnimationFrame(c)};let l=requestAnimationFrame(c);return()=>{cancelAnimationFrame(l),e.disconnect(),r.disconnect()}}};let s=r();const a=()=>{"function"==typeof s&&s(),s=r()};return e.emitter.on(Je,a),()=>{e.emitter.off(Je,a),"function"==typeof s&&s(),o.abort()}}}),[e,t]),e?(0,Pt.jsx)("canvas",{ref:n,style:{width:"70px",height:"30px"}}):(0,Pt.jsx)("div",{style:{fontSize:8},children:"No audio recorder available"})}},46314:(e,t,n)=>{n(82109)({target:"Object",stat:!0},{hasOwn:n(92597)})},40366:(e,t,n)=>{"use strict";e.exports=n.p+"dbc10b469ee58d20.js"},65820:(e,t,n)=>{"use strict";n.d(t,{M:()=>m});var o=n(67294),i=n(58868);function r(){const e=(0,o.useRef)(!1);return(0,i.L)((()=>(e.current=!0,()=>{e.current=!1})),[]),e}var s=n(2074);var a=n(240),c=n(96681);class l extends o.Component{getSnapshotBeforeUpdate(e){const t=this.props.childRef.current;if(t&&e.isPresent&&!this.props.isPresent){const e=this.props.sizeRef.current;e.height=t.offsetHeight||0,e.width=t.offsetWidth||0,e.top=t.offsetTop,e.left=t.offsetLeft}return null}componentDidUpdate(){}render(){return this.props.children}}function d({children:e,isPresent:t}){const n=(0,o.useId)(),i=(0,o.useRef)(null),r=(0,o.useRef)({width:0,height:0,top:0,left:0});return(0,o.useInsertionEffect)((()=>{const{width:e,height:o,top:s,left:a}=r.current;if(t||!i.current||!e||!o)return;i.current.dataset.motionPopId=n;const c=document.createElement("style");return document.head.appendChild(c),c.sheet&&c.sheet.insertRule(`\n          [data-motion-pop-id="${n}"] {\n            position: absolute !important;\n            width: ${e}px !important;\n            height: ${o}px !important;\n            top: ${s}px !important;\n            left: ${a}px !important;\n          }\n        `),()=>{document.head.removeChild(c)}}),[t]),o.createElement(l,{isPresent:t,childRef:i,sizeRef:r},o.cloneElement(e,{ref:i}))}const u=({children:e,initial:t,isPresent:n,onExitComplete:i,custom:r,presenceAffectsLayout:s,mode:l})=>{const u=(0,c.h)(h),p=(0,o.useId)(),g=(0,o.useMemo)((()=>({id:p,initial:t,isPresent:n,custom:r,onExitComplete:e=>{u.set(e,!0);for(const t of u.values())if(!t)return;i&&i()},register:e=>(u.set(e,!1),()=>u.delete(e))})),s?void 0:[n]);return(0,o.useMemo)((()=>{u.forEach(((e,t)=>u.set(t,!1)))}),[n]),o.useEffect((()=>{!n&&!u.size&&i&&i()}),[n]),"popLayout"===l&&(e=o.createElement(d,{isPresent:n},e)),o.createElement(a.O.Provider,{value:g},e)};function h(){return new Map}var p=n(25364),g=n(65411),f=n(45487);const v=e=>e.key||"";const m=({children:e,custom:t,initial:n=!0,onExitComplete:a,exitBeforeEnter:c,presenceAffectsLayout:l=!0,mode:d="sync"})=>{(0,f.k)(!c,"Replace exitBeforeEnter with mode='wait'");const h=(0,o.useContext)(p.p).forceRender||function(){const e=r(),[t,n]=(0,o.useState)(0),i=(0,o.useCallback)((()=>{e.current&&n(t+1)}),[t]);return[(0,o.useCallback)((()=>s.Wi.postRender(i)),[i]),t]}()[0],m=r(),S=function(e){const t=[];return o.Children.forEach(e,(e=>{(0,o.isValidElement)(e)&&t.push(e)})),t}(e);let w=S;const y=(0,o.useRef)(new Map).current,b=(0,o.useRef)(w),k=(0,o.useRef)(new Map).current,C=(0,o.useRef)(!0);if((0,i.L)((()=>{C.current=!1,function(e,t){e.forEach((e=>{const n=v(e);t.set(n,e)}))}(S,k),b.current=w})),(0,g.z)((()=>{C.current=!0,k.clear(),y.clear()})),C.current)return o.createElement(o.Fragment,null,w.map((e=>o.createElement(u,{key:v(e),isPresent:!0,initial:!!n&&void 0,presenceAffectsLayout:l,mode:d},e))));w=[...w];const x=b.current.map(v),R=S.map(v),I=x.length;for(let o=0;o<I;o++){const e=x[o];-1!==R.indexOf(e)||y.has(e)||y.set(e,void 0)}return"wait"===d&&y.size&&(w=[]),y.forEach(((e,n)=>{if(-1!==R.indexOf(n))return;const i=k.get(n);if(!i)return;const r=x.indexOf(n);let s=e;if(!s){const e=()=>{y.delete(n);const e=Array.from(k.keys()).filter((e=>!R.includes(e)));if(e.forEach((e=>k.delete(e))),b.current=S.filter((t=>{const o=v(t);return o===n||e.includes(o)})),!y.size){if(!1===m.current)return;h(),a&&a()}};s=o.createElement(u,{key:v(i),isPresent:!1,onExitComplete:e,custom:t,presenceAffectsLayout:l,mode:d},i),y.set(n,s)}w.splice(r,0,s)})),w=w.map((e=>{const t=e.key;return y.has(t)?e:o.createElement(u,{key:v(e),isPresent:!0,presenceAffectsLayout:l,mode:d},e)})),o.createElement(o.Fragment,null,y.size?w:w.map((e=>(0,o.cloneElement)(e))))}}}]);